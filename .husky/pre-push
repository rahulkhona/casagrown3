#!/bin/sh

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Pre-push hook โ Full E2E test suite
# Starts/stops dev servers, simulators as needed, runs all tests.
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

set -e

ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR"

# Track PIDs so we can clean up on exit
PIDS_TO_KILL=""
SUPABASE_STARTED_BY_US=false

cleanup() {
    echo ""
    echo "๐งน Cleaning up..."
    for pid in $PIDS_TO_KILL; do
        kill "$pid" 2>/dev/null && echo "   Stopped background process $pid"
    done

    if [ "$SUPABASE_STARTED_BY_US" = true ]; then
        echo "   Stopping Supabase..."
        supabase stop 2>/dev/null || true
    fi
    echo "๐งน Cleanup complete."
}
trap cleanup EXIT

# โโโ Helpers โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

wait_for_port() {
    local port=$1
    local label=$2
    local timeout=${3:-60}
    local elapsed=0
    echo "   Waiting for $label on port $port..."
    while ! curl -s "http://localhost:$port" > /dev/null 2>&1; do
        sleep 2
        elapsed=$((elapsed + 2))
        if [ "$elapsed" -ge "$timeout" ]; then
            echo "โ Timed out waiting for $label on port $port"
            exit 1
        fi
    done
    echo "   โ $label ready on port $port"
}

is_port_in_use() {
    lsof -i :"$1" -sTCP:LISTEN > /dev/null 2>&1
}

echo "๐ Running pre-push checks..."
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PHASE 1: Unit Tests (no servers needed)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โโโ Phase 1: Unit Tests โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

echo "๐ [1/4] Community App unit tests (jest)..."
yarn workspace @casagrown/app jest --passWithNoTests --bail 2>&1 || {
    echo "โ Community App unit tests failed โ push aborted."
    exit 1
}

echo "๐ [2/4] Community Voice unit tests (vitest)..."
cd apps/next-community-voice && npx vitest run --reporter=dot 2>&1 || {
    echo "โ Community Voice unit tests failed โ push aborted."
    exit 1
}
cd "$ROOT_DIR"

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PHASE 2: Playwright E2E (start web dev servers if needed)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PHASE 1.5: Supabase (database, auth, edge functions, realtime)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โโโ Infrastructure: Supabase โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

if supabase status > /dev/null 2>&1; then
    echo "   โ Supabase already running"
else
    echo "   Starting Supabase (db, auth, edge functions, realtime, storage)..."
    supabase start 2>&1 || {
        echo "โ Failed to start Supabase โ push aborted."
        exit 1
    }
    SUPABASE_STARTED_BY_US=true
    echo "   โ Supabase started"
fi

echo ""

echo "โโโ Phase 2: Playwright E2E (Web) โโโโโโโโโโโโโโโโโโโโโโโโโโ"

# --- Start Community Voice dev server (port 3002) if not running ---
if is_port_in_use 3002; then
    echo "   โ Community Voice dev server already running on 3002"
else
    echo "   Starting Community Voice dev server (port 3002)..."
    cd apps/next-community-voice && yarn dev > /dev/null 2>&1 &
    PIDS_TO_KILL="$PIDS_TO_KILL $!"
    cd "$ROOT_DIR"
    wait_for_port 3002 "Community Voice" 90
fi

echo "๐ญ [3/4] Community Voice Playwright E2E tests..."
cd apps/next-community-voice && npx playwright test --reporter=dot 2>&1 || {
    echo "โ Community Voice Playwright tests failed โ push aborted."
    exit 1
}
cd "$ROOT_DIR"

# --- Start Community Web dev server (port 3000) if not running ---
if is_port_in_use 3000; then
    echo "   โ Community Web dev server already running on 3000"
else
    echo "   Starting Community Web dev server (port 3000)..."
    yarn web > /dev/null 2>&1 &
    PIDS_TO_KILL="$PIDS_TO_KILL $!"
    wait_for_port 3000 "Community Web" 90
fi

echo "๐ญ [4/4] Community Web Playwright E2E tests..."
npx playwright test --config=e2e/playwright/playwright.config.ts --reporter=dot 2>&1 || {
    echo "โ Community Web Playwright tests failed โ push aborted."
    exit 1
}

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PHASE 3: Maestro Mobile E2E
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โโโ Phase 3: Maestro E2E (Mobile) โโโโโโโโโโโโโโโโโโโโโโโโโโ"

# --- Start Expo Native dev server (port 8081) if not running ---
if is_port_in_use 8081; then
    echo "   โ Expo dev server already running on 8081"
else
    echo "   Starting Expo dev server (port 8081)..."
    CI=1 yarn native > /dev/null 2>&1 &
    PIDS_TO_KILL="$PIDS_TO_KILL $!"
    wait_for_port 8081 "Expo Dev Server" 90
fi

IOS_UDID=$(xcrun simctl list devices | grep Booted | grep -v 'Apple Watch' | head -1 | awk -F'[()]' '{print $2}')
if [ -n "$IOS_UDID" ]; then
    echo "๐ฑ [5/6] iOS Maestro Mobile E2E tests..."
    maestro --udid "$IOS_UDID" test e2e/maestro/ || {
        echo "โ iOS Maestro tests failed โ push aborted."
        exit 1
    }
else
    echo "โ๏ธ No booted iOS Simulator found. Skipping iOS Maestro tests."
fi

ANDROID_SERIAL=$(adb devices | grep -v "List" | grep "device$" | head -1 | awk '{print $1}')
if [ -n "$ANDROID_SERIAL" ]; then
    echo "๐ฑ [6/6] Android Maestro Mobile E2E tests..."
    maestro --udid "$ANDROID_SERIAL" test e2e/maestro/ || {
        echo "โ Android Maestro tests failed โ push aborted."
        exit 1
    }
else
    echo "โ๏ธ No attached Android device/emulator found. Skipping Android Maestro tests."
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Done
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ All pre-push checks passed!"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
