appId: dev.casagrown.community

env:
        TEST_EMAIL: "seller@test.local"

---
# Login utility flow — reusable for other tests
# Uses OTP email authentication flow
# Test user: seller@test.local (seeded by seed.sql)
#
# Flow: Landing page → Login page → Email OTP → Feed/Wizard
#
# Uses stopApp + launchApp to guarantee a fresh app start from the root
# screen regardless of where the previous flow left the app.

- stopApp:
          appId: dev.casagrown.community
- launchApp:
          clearState: false
          clearKeychain: false
          stopApp: false

# The Expo dev-client shows a launcher with the dev server URL.
# Tap it to load the JS bundle.  If the app is already past this
# screen (e.g. when clearState kept the session), the runFlow guard
# will skip this step.
- runFlow:
          when:
                  visible: "localhost"
          commands:
                  - tapOn: "localhost"

# Wait for the app to fully load before checking conditions.
# The app may show any of these screens after launch:
#   - "Create Post" → already logged in, on feed
#   - "Join the Movement!" → landing page, not logged in
#   - "Welcome to CasaGrown" → login page
#   - "Let's Get You Set Up" → profile wizard
#   - "Loading..." → auth check in progress (wait for it to resolve)
- extendedWaitUntil:
          visible:
                  text: ".*(?:Create Post|Join the Movement|Welcome to CasaGrown|Get You Set Up).*"
          timeout: 45000

# If already logged in (feed shows "Create Post"), skip login
- runFlow:
          when:
                  visible: "Create Post"
          commands:
                  - assertVisible: "Create Post"

# If on the landing page, tap "Join the Movement!" to get to login
- runFlow:
          when:
                  visible: "Join the Movement!"
          commands:
                  - tapOn: "Join the Movement!"
                  - extendedWaitUntil:
                            visible: "Welcome to CasaGrown"
                            timeout: 15000

# Now perform email OTP login
- runFlow:
          when:
                  visible: "Welcome to CasaGrown"
          commands:
                  # Tap "Continue with Email"
                  - tapOn: "Continue with Email"

                  # Wait for email input
                  - extendedWaitUntil:
                            visible: "Email Address"
                            timeout: 5000

                  # Enter test seller email — clear first, then type, then dismiss keyboard
                  - tapOn:
                            id: "email_input"
                  - eraseText: 30
                  - inputText: "${TEST_EMAIL}"
                  - hideKeyboard

                  # Tap send code button
                  - tapOn: "Send Verification Code"

                  # Wait for OTP screen to appear
                  - extendedWaitUntil:
                            visible: "Verification Code"
                            timeout: 15000

                  # Tap Verify & Continue (dev mode auto-fills OTP)
                  - tapOn: "Verify & Continue"

                  # Wait for navigation to complete (feed or wizard)
                  - extendedWaitUntil:
                            visible:
                                    text: ".*(?:Create Post|Get You Set Up).*"
                            timeout: 15000

# If wizard shows after login, step through it
- runFlow:
          when:
                  visible:
                          text: ".*Get You Set Up.*"
          commands:
                  - tapOn: "Continue"
                  - extendedWaitUntil:
                            visible:
                                    text: ".*"
                            timeout: 10000
                  - tapOn: "Continue"
                  - extendedWaitUntil:
                            visible:
                                    text: ".*"
                            timeout: 10000
                  - tapOn: "Continue"
                  - extendedWaitUntil:
                            visible:
                                    text: ".*"
                            timeout: 10000
